<template>
  <div class="app-container calendar-list-container">
    <!--<el-button type="primary" v-waves icon="el-icon-refresh" size="small" @click="show = !show">筛选</el-button>-->
    <transition name="el-zoom-in-top">
      <div class="filter-container transition-box" v-show="show">
        <div class="filter-item">
          <div class="filter-label">订单下单时间</div>
          <el-date-picker v-model="listQuery.date_range"
                          type="daterange"
                          format="yyyy-MM-dd"
                          value-format="yyyy-MM-dd"
                          align="right"
                          size="small"
                          style="width: 250px"
                          unlink-panels
                          range-separator="~"
                          start-placeholder="开始日期"
                          end-placeholder="结束日期"
                          :picker-options="pickerOptions2">
          </el-date-picker>
        </div>
        <div class="filter-item">
          <div class="filter-label">子订单号</div>
          <el-input @keyup.enter.native="handleFilter"
                    style="width: 180px;" size="small"
                    v-model="listQuery.orders_unique_id">
          </el-input>
        </div>
        <div class="filter-item">
          <div class="filter-label">订单号</div>
          <el-input @keyup.enter.native="handleFilter"
                    style="width: 180px;" size="small"
                    v-model="listQuery.orders_shop_unique_id">
          </el-input>
        </div>
        <div class="filter-item">
          <div class="filter-label">物流单号</div>
          <el-input @keyup.enter.native="handleFilter" style="width: 150px;" size="small"
                    v-model="listQuery.orders_logistics_number">
          </el-input>
        </div>
        <!--<div class="filter-item">-->
          <!--<div class="filter-label">备注信息</div>-->
          <!--<el-input @keyup.enter.native="handleFilter"-->
                    <!--size="small"-->
                    <!--style="width: 200px;"-->
                    <!--v-model="listQuery.remark">-->
          <!--</el-input>-->
        <!--</div>-->
        <div class="filter-item">
          <div class="filter-label">收货人</div>
          <el-input @keyup.enter.native="handleFilter"
            size="small"
            style="width: 100px;"
            v-model="listQuery.receive_name">
          </el-input>
        </div>
        <div class="filter-item">
          <div class="filter-label">客户电话</div>
          <el-input @keyup.enter.native="handleFilter"
                    size="small"
                    style="width: 140px;"
                    v-model="listQuery.receive_phone">
          </el-input>
        </div>
        <el-button class="filter-item" type="primary" v-waves icon="el-icon-search" size="small"
                   @click="handleFilter">搜索
        </el-button>
        <!--<el-button class="filter-item" type="primary" v-waves icon="el-icon-edit" size="small" @click="handleCreate">-->
          <!--添加-->
        <!--</el-button>-->
        <!--<el-button class="filter-item" type="primary" v-waves icon="el-icon-download" size="small" @click="downExcel">-->
          <!--导出-->
        <!--</el-button>-->
      </div>
    </transition>
    <div :class="tableLoading">
      <el-tabs v-model="tabSelection" type="card" @tab-click="handleClick">
        <el-tab-pane label="全部订单" name="all"></el-tab-pane>
        <el-tab-pane label="待付款" name="1"></el-tab-pane>
        <el-tab-pane label="待发货" name="2"></el-tab-pane>
        <el-tab-pane label="已发货" name="3"></el-tab-pane>
        <el-tab-pane label="已完成" name="4"></el-tab-pane>
        <el-tab-pane name="99"><span slot="label">已退回 <i class="el-icon-warning"></i></span></el-tab-pane>
      </el-tabs>
      <sticky :sticky-top="74">
        <el-row>
          <el-col :span="10">
            <div class="grid-content bg-purple">商品</div>
          </el-col>
          <el-col :span="4">
            <div class="grid-content bg-purple-light">买家</div>
          </el-col>
          <el-col :span="4">
            <div class="grid-content bg-purple">价格</div>
          </el-col>
          <el-col :span="4">
            <div class="grid-content bg-purple-light">状态</div>
          </el-col>
          <el-col :span="2">
            <div class="grid-content bg-purple">操作</div>
          </el-col>
        </el-row>
      </sticky>
      <div v-for="orders in list" :key="orders.id">
        <div
          style="border:1px solid #ebeef5;width:100%;line-height:20px;padding:15px 20px;background-color:#f7f8fa;margin-bottom:-1px;color:#323233;">
          <div style="float:left;display:table-cell;line-height:30px;">
            <span style="margin-left: 20px;">
              <span>订单号： {{orders.orders_shop_unique_id}}</span>
            </span>
            <span style="margin-left: 10px;float:left;">
              子订单号：
            </span>
            <span style="float:left;">
                <span style="display: block" v-if="orders.orders.length > 0" v-for="(item, i) in orders.orders" :key="i">
                  {{item.orders_unique_id}}
                  <el-tag size="mini" type="success">{{item.status|orderStatusTranslator2}}</el-tag>
                </span>
              </span>
            <el-tag size="mini" type="primary" v-show="orders.source_id === 4">商城</el-tag>
            <el-tag size="mini" type="warning" v-show="orders.source_id === 1">直营</el-tag>
            <el-tag size="mini" type="warning" v-show="orders.if_repurchase > 1">复购</el-tag>
            <span style="margin-left:10px;">下单时间： {{orders.created_at}}</span>
          </div>
          <div style="float:right;" @click="gotoDetail(orders.id)">
            <el-button size="mini" type="info">查看详情</el-button>
          </div>
          <div style="clear:both;"></div>
        </div>
        <el-table :show-header="hideTableHeader" :key='tableKey2' :data="[orders]" element-loading-text="给我一点时间" border
                  fit
                  style="width: 100%;"
                  :row-style="rowStyle1"
                  :cell-style="cellStyle1">
          <el-table-column align="left" label="商品" min-width="280">
            <template slot-scope="scope">
              <el-table :show-header="hideTableHeader" :key='tableKey2' :cell-style="cellStyle2"
                        :data="scope.row.orders_shop_items" element-loading-text="给我一点时间" fit
                        style="width: 100%;border:none;margin-bottom:-2px;">
                <el-table-column align="left" label="商品">
                  <template slot-scope="scope">
                    <div v-if="scope.row.shop_goods === '' || scope.row.shop_goods === null || scope.row.shop_goods === undefined">
                      <img style="width:65px;height:65px;float:left;" :src="scope.row.shop_goods_common.main_images_default"/>
                      <div style="width:70%;padding-left:10px;float:left">
                        <p class="link-type" style="margin:0;margin-top:2px;">
                          {{scope.row.shop_goods_common.goods_name + '-' + scope.row.shop_goods_common.goods_title}}
                        </p>
                        <p class="my-form-p">
                          <span></span>
                        </p>
                      </div>
                      <div style="float:right;padding-top:15px;">
                        <p class="my-form-p">
                          {{scope.row.price}}
                        </p>
                        <p class="my-form-p" style="text-align:right">
                          {{scope.row.number}}件
                        </p>
                      </div>
                    </div>
                    <div v-else>
                      <img style="width:65px;height:65px;float:left;" :src="scope.row.shop_goods.image_thumb"/>
                      <div style="width:70%;padding-left:10px;float:left">
                        <p class="link-type" style="margin:0;margin-top:2px;">
                          {{scope.row.shop_goods_common.goods_name + '-' + scope.row.shop_goods_common.goods_title}}
                        </p>
                        <p class="my-form-p">
                          <span v-for="(item,index) in scope.row.shop_species_value" :key="index">{{item}} </span>
                        </p>
                      </div>
                      <div style="float:right;padding-top:15px;">
                        <p class="my-form-p">
                          {{scope.row.price}}
                        </p>
                        <p class="my-form-p" style="text-align:right">
                          {{scope.row.number}}件
                        </p>
                      </div>
                    </div>
                  </template>
                </el-table-column>
              </el-table>
            </template>
          </el-table-column>
          <el-table-column min-width="100" align="center" label="收货人">
            <template slot-scope="scope">
              <el-popover trigger="click" placement="top">
                <p>收货地址: {{ scope.row.orders_shop_receiver_info.province_name +
                  scope.row.orders_shop_receiver_info.city_name +
                  (scope.row.orders_shop_receiver_info.district_name !== undefined ?
                  scope.row.orders_shop_receiver_info.district_name : '') +
                  scope.row.orders_shop_receiver_info.address}}</p>
                <span slot="reference" class="link-type">{{scope.row.orders_shop_receiver_info.receive_name}}</span>
              </el-popover>
              <p style="padding:0;margin:0;">
                {{scope.row.orders_shop_receiver_info.phone}}
              </p>
            </template>
          </el-table-column>
          <el-table-column min-width="90" align="center" label="订单金额">
            <template slot-scope="scope">
              <span>￥{{scope.row.actual_pay}}</span><br>
              <span style="color:#aaa;">(含运费:{{scope.row.freight}})</span>
            </template>
          </el-table-column>
          <el-table-column min-width="100" align="center" label="状态">
            <template slot-scope="scope">
              {{scope.row|orderStatusTranslator}}
            </template>
          </el-table-column>
          <el-table-column min-width="100" align="center" label="操作">
            <template slot-scope="scope">
              <span class="link-type" @click="getOrdersShopDistributionInfo(scope.row.id)" ><span>佣金明细</span><br></span>
            </template>
          </el-table-column>
        </el-table>
        <div
          style="background-color:#fffaeb;border:1px solid #ebeef5;width:100%;line-height:10px;padding: 14px 10px 14px 20px;color:#f90;font-size:14px;margin-top:-1px;">
          <span>
            买家:
          </span>
          <span>
            {{orders.remark}}
          </span>
          <span v-if="orders.orders_remarks.length > 0" v-for="(remark,index) in orders.orders_remarks" :key="index">
            <span v-if="remark.status === 1">{{remark.type_name}}：</span>
            <span v-if="remark.status === 1">{{remark.remark}}&nbsp;&nbsp;&nbsp;&nbsp;</span>
          </span>
        </div>
        <br>
      </div>
    </div>
    <div v-show="!listLoading" class="pagination-container">
      <el-pagination background @size-change="handleSizeChange" @current-change="handleCurrentChange"
                     :current-page.sync="listQuery.page"
                     :page-sizes="[10,20,30, 50]" :page-size="listQuery.page_size"
                     layout="total, sizes, prev, pager, next, jumper" :total="total">
      </el-pagination>
    </div>

    <el-dialog :title="textMap[dialogStatus]" :visible.sync="dialogFormVisible">
      <el-form :rules="rules" ref="dataForm1" :model="temp" label-position="left" label-width="20%"
               style='width: 80%; margin-left:10%;'>
        <el-form-item label="客服" prop="support_member.id">
          <multiselect v-model="temp.support_member" :options="supportMemberOptions"
                       @input="resetSupportMember" @search-change="querySupportMemberList" placeholder="搜索客服"
                       selectLabel="选择"
                       deselectLabel="删除" track-by="nickname" :internalSearch="false" label="nickname">
            <span slot='noResult'>无结果</span>
          </multiselect>
        </el-form-item>
        <el-form-item label="录单类型" prop="promotion_product_type_id">
          <el-radio-group v-model="temp.create_orders_type" size="medium">
            <el-radio-button value="1" label="1">选择录入粉丝</el-radio-button>
            <el-radio-button value="2" label="2">微信加粉时间</el-radio-button>
          </el-radio-group>
        </el-form-item>
        <el-form-item v-if="parseInt(temp.create_orders_type) === 1" label="粉丝微信号" prop="product_weixin_fans.id">
          <multiselect v-model="temp.product_weixin_fans" :options="productWeixinFansOptions"
                       @input="resetWarehouse2" @search-change="queryProductWeixinFansList" placeholder="搜索粉丝微信号"
                       selectLabel="选择"
                       deselectLabel="删除" track-by="weixin_account" :internalSearch="false" label="weixin_account">
            <template slot="singleLabel" slot-scope="props">
            <span class="option__desc" v-if="props.option.weixin_account">
              <span class="option__title">{{ props.option.weixin_account}}</span>
              <span style="color: #666;background-color: #dbdbdb;padding: 2px 8px;border-radius:5px;">{{ props.option.product_weixin.info }}</span>
            </span>
            </template>
            <template slot="option" slot-scope="props">
            <span class="option__desc" v-if="props.option.weixin_account">
              <span class="option__title">{{ props.option.weixin_account}}</span>
              <span style="color: #666;background-color: #dbdbdb;padding: 1px 8px;border-radius:5px;">{{ props.option.product_weixin.info }}</span>
            </span>
            </template>
            <span slot='noResult'>无结果</span>
          </multiselect>
        </el-form-item>
        <el-form-item v-if="parseInt(temp.create_orders_type) === 2" label="推广微信号" prop="product_weixin.id">
          <multiselect v-model="temp.product_weixin" :options="productWeixinOptions" @input="resetWarehouse"
                       @search-change="queryProductWeixinList" placeholder="搜索推广微信号" selectLabel="选择"
                       deselectLabel="删除" track-by="weixin_account" :internalSearch="false" label="weixin_account">
            <span slot='noResult'>无结果</span>
          </multiselect>
        </el-form-item>
        <el-form-item v-if="parseInt(temp.create_orders_type) === 2" label="加粉时间" prop="fans_join_time">
          <el-date-picker
            v-model="temp.fans_join_time"
            style="width: 100%"
            format="yyyy-MM-dd HH:mm"
            align="right"
            type="datetime"
            value-format="yyyy-MM-dd HH:mm"
            placeholder="选择加粉时间"
            :picker-options="pickerOptions1">
          </el-date-picker>
        </el-form-item>
        <el-form-item label="收货人信息" v-if="!showReceiverForm">
          <el-input type="textarea" v-model="temp_receiver_info" :autosize="{ minRows: 6, maxRows: 20 }"
                    placeholder="将客户姓名, 电话, 收货地址信息复制到这里, 点击智能识别, 系统自动识别并补全收货信息"></el-input>
        </el-form-item>
        <el-form-item v-if="!showReceiverForm">
          <el-button style="float: right; width:100%;" type="primary" @click="smartParse">智能识别</el-button>
        </el-form-item>
        <div v-if="showReceiverForm">
          <el-form-item label="收货人姓名/电话" prop="receive_name">
            <el-input style="width:50%" placeholder="姓名" v-model="temp.orders_receiver_info.receive_name"></el-input>
            <el-input style="width:49%" placeholder="电话" v-model.trim="temp.orders_receiver_info.phone"></el-input>
          </el-form-item>
          <el-form-item label="收货地址" prop="address">
            <el-cascader
              size="large"
              change-on-select
              :options="regionData"
              v-model="temp.orders_receiver_info.regions"
              @change="handleRegionChange"
              :props="props"
              style="width:100%;">
            </el-cascader>
          </el-form-item>
          <el-form-item label="地址详情" prop="address">
            <el-input placeholder="请输入收货地址详情" v-model="temp.orders_receiver_info.address"></el-input>
          </el-form-item>
          <el-form-item label="仓库/发货时间" prop="warehouse_id">
            <el-select
              v-model="temp.warehouse_id"
              style="width: 50%"
              placeholder="仓库">
              <el-option
                v-for="item in warehouseOptions"
                :key="item.id"
                :label="item.name"
                :value="item.id">
              </el-option>
            </el-select>
            <el-date-picker
              v-model="temp.deliver_date"
              style="width: 49%"
              align="right"
              type="date"
              format="yyyy-MM-dd"
              value-format="yyyy-MM-dd"
              placeholder="选择日期"
              :picker-options="pickerOptions1">
            </el-date-picker>
            <p v-if="dialogStatus !== 'update'" style="margin:0;padding:0;text-align:right;">收货信息识别错误？ <span
              @click="handleUnidenfyReceiverInfo" class="link-type">点击上报</span></p>
          </el-form-item>
        </div>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="dialogFormVisible = false">取 消</el-button>
        <el-button v-if="stepStatus=='create'" :loading="btnLoading" type="primary" @click="createData">确 定</el-button>
        <el-button v-else type="primary" @click="updateData">确 定</el-button>
      </div>
    </el-dialog>
    <el-dialog title="退款详情" :visible.sync="innerDialogFormVisible7" width="40%">
      <el-form :rules="innerRules7" ref="innerDataForm7" :model="innerTemp7" label-position="left" label-width="100px"
               style='width: 80%; margin-left:10%;'>
        <el-form-item label="状态" prop="status">
          <el-radio-group v-model="innerTemp7.status" size="medium" disabled="">
            <el-radio-button label="1">待审核</el-radio-button>
            <el-radio-button label="2">已退款</el-radio-button>
            <el-radio-button label="3">审核失败</el-radio-button>
          </el-radio-group>
        </el-form-item>
        <el-form-item label="退款金额" prop="number">
          <el-input v-model="innerTemp7.refund_money"></el-input>
        </el-form-item>
        <el-form-item label="收款人信息">
          <el-input type="textarea" v-model="innerTemp7.receiver_info"
                    :autosize="{ minRows: 6, maxRows: 20 }"></el-input>
        </el-form-item>
        <el-form-item label="备注" v-if="innerTemp7.remark">
          {{innerTemp7.remark}}
        </el-form-item>
        <el-form-item v-if="innerTemp7.refund_img_url" label="转款截图">
          <img style="width: 100px; height: 100px" :src="innerTemp7.refund_img_url"
               @click="handleOpenImage(innerTemp7.refund_img_url)"/>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="innerDialogFormVisible7 = false">取 消</el-button>
        <el-button type="primary" :loading="btnLoading7" @click="updateInnerData7">确 定</el-button>
      </div>
    </el-dialog>
    <el-dialog :title="innerTableTitle1" :visible.sync="innerTableVisible1" width="60%">
      <div class="filter-container" align="right">
        <el-button align="right" class="filter-item" @click="handleInnerCreate1"
                   type="primary" icon="el-icon-edit">添加
        </el-button>
      </div>
      <el-table :key='innerTableKey1' :data="orders_items" v-loading="ordersItemLoading"
                element-loading-text="给我一点时间" border fit highlight-current-row
                style="width: 100%">
        <!--<el-table-column align="center" label="序号" min-width="65">-->
        <!--<template slot-scope="scope">-->
        <!--<span>{{scope.row.id}}</span>-->
        <!--</template>-->
        <!--</el-table-column>-->
        <el-table-column min-width="260" align="center" label="商品名称">
          <template slot-scope="scope">
            <span class="link-type" @click="handleInnerUpdate1(scope.row)">{{scope.row.product_goods.goods_name}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="100px" align="center" label="数量">
          <template slot-scope="scope">
            <span>{{scope.row.number}}</span>
            <span v-if="scope.row.product_goods.unit !== '0' && scope.row.product_goods.unit !== null">({{scope.row.product_goods.unit}})</span>
          </template>
        </el-table-column>
        <el-table-column min-width="180px" align="center" label="添加时间">
          <template slot-scope="scope">
            <span>{{scope.row.updated_at}}</span>
          </template>
        </el-table-column>
        <el-table-column align="center" label="操作" width="180" class-name="small-padding">
          <template slot-scope="scope">
            <el-button type="primary" size="mini" @click="handleInnerUpdate1(scope.row)">编辑</el-button>
            <el-button type="danger" size="mini" @click="handleInnerDelete1(scope.row)">删除</el-button>
          </template>
        </el-table-column>
      </el-table>
      <div slot="footer" class="dialog-footer">
        <el-button v-if="stepStatus == 'create'" type="primary" @click="handleOpenInner4">下一步</el-button>
        <el-button v-else type="primary" @click="innerTableVisible1 = false">确 定</el-button>
      </div>
    </el-dialog>

    <el-dialog :title="textMap[dialogStatus]" :visible.sync="innerDialogFormVisible1" width="40%">
      <el-form :rules="innerRules1" ref="innerDataForm1" :model="innerTemp1" label-position="left" label-width="80px"
               style='width: 80%; margin-left:10%;'>
        <el-form-item label="商品名称" prop="product_goods.id">
          <el-select
            @focus="queryProductGoodsList(' ')"
            v-model="innerTemp1.product_goods"
            filterable
            value-key="id"
            style="width:100%;"
            remote
            placeholder="商品"
            :remote-method="queryProductGoodsList">
            <el-option
              v-for="item in productGoodsOptions"
              :key="item.id"
              :label="item.goods_name"
              :value="item">
              <span style="float: left">{{ item.goods_name }}</span>
              <span style="float: right; color: #8492a6; font-size: 13px">{{ item.unit }}</span>
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="数量" prop="number">
          <el-input v-model="innerTemp1.number"></el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="innerDialogFormVisible1 = false">取 消</el-button>
        <el-button v-if="dialogStatus == 'create'" type="primary" :loading="btnLoading" @click="createInnerData1">确 定
        </el-button>
        <el-button v-else type="primary" :loading="btnLoading" @click="updateInnerData1">确 定</el-button>
      </div>
    </el-dialog>

    <el-dialog :title="innerTableTitle2" :visible.sync="innerTableVisible2" width="90%">
      <div class="filter-container" align="right">
        <el-button align="right" class="filter-item" style="margin-left: 10px;" @click="handleInnerCreate2"
                   type="primary" icon="el-icon-edit">添加
        </el-button>
      </div>
      <el-table :key='innerTableKey2' :data="temp.orders_remarks" v-loading="innerListLoading2"
                element-loading-text="给我一点时间" border fit highlight-current-row
                style="width: 100%">
        <el-table-column align="center" label="序号" width="100">
          <template slot-scope="scope">
            <span>{{scope.row.id}}</span>
          </template>
        </el-table-column>
        <el-table-column width="100px" align="center" label="用户身份">
          <template slot-scope="scope">
            <span class="link-type">{{scope.row.user_account_type_id|userTypeStatusTranslator}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="100px" align="center" label="内容">
          <template slot-scope="scope">
            <span :class="scope.row.status === 0?if_deleted:'link-type'">{{scope.row.remark}}</span>
          </template>
        </el-table-column>
        <el-table-column width="180px" align="center" label="添加时间">
          <template slot-scope="scope">
            <span>{{scope.row.updated_at}}</span>
          </template>
        </el-table-column>
        <el-table-column align="center" label="操作" width="220" class-name="small-padding">
          <template slot-scope="scope">
            <el-button v-if="scope.row.status===1" size="mini" type="danger" @click="handleInnerDelete2(scope.row)">删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-dialog>
    <el-dialog :title="innerTableTitle3" :visible.sync="innerTableVisible3" width="60%">
      <el-table :key='innerTableKey3' :data="innerList3" v-loading="innerListLoading3" element-loading-text="给我一点时间"
                border fit highlight-current-row
                style="width: 100%">
        <el-table-column align="center" label="时间" min-width="120px">
          <template slot-scope="scope">
            <span>{{scope.row.created_at}}</span>
          </template>
        </el-table-column>
        <el-table-column align="center" label="操作人" min-width="100px">
          <template slot-scope="scope">
            <span>{{scope.row.nickname}}</span>
          </template>
        </el-table-column>
        <el-table-column align="center" label="具体操作" min-width="200px">
          <template slot-scope="scope">
            <span>{{scope.row.action_desc}}</span>
          </template>
        </el-table-column>
      </el-table>
      <div v-show="!innerListLoading1" class="pagination-container">
        <el-pagination background @size-change="handleInnerSizeChange3" @current-change="handleInnerCurrentChange3"
                       :current-page.sync="innerListQuery3.page"
                       :page-sizes="[10,20,50,100]" :page-size="innerListQuery3.page_size"
                       layout="total, sizes, prev, pager, next, jumper" :total="innerTotal3">
        </el-pagination>
      </div>
    </el-dialog>

    <el-dialog :title="textMap[dialogStatus]" :visible.sync="innerDialogFormVisible2" width="50%">
      <el-form :rules="innerRules2" ref="innerDataForm2" :model="innerTemp2" label-position="left" label-width="80px"
               style='width: 80%; margin-left:10%;'>
        <el-form-item label="备注信息" prop="remark">
          <el-input type="textarea" :autosize="{ minRows: 5, maxRows: 15}" placeholder="请输入内容"
                    v-model="innerTemp2.remark">
          </el-input>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="innerDialogFormVisible2 = false">取 消</el-button>
        <el-button v-if="dialogStatus == 'create'" :loading="btnLoading" type="primary" @click="createInnerData2">确 定
        </el-button>
      </div>
    </el-dialog>
    <el-dialog :title="innerTableTitle5" :visible.sync="innerTableVisible5" width="80%">
      <div class="filter-container" align="right">
        <el-button align="right" class="filter-item" style="margin-left: 10px;" @click="handleInnerCreate5"
                   type="primary" icon="el-icon-edit">添加
        </el-button>
      </div>
      <el-table :key='innerTableKey5' v-if="temp.orders_payment" :data="temp.orders_payment.orders_payment_items"
                v-loading="innerListLoading5"
                element-loading-text="给我一点时间" border fit highlight-current-row
                style="width: 100%">
        <el-table-column align="center" label="序号" min-width="65">
          <template slot-scope="scope">
            <span>{{scope.row.id}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="100px" align="center" label="收款方式">
          <template slot-scope="scope">
            <span class="link-type"
                  v-if="scope.row.orders_pay_type.type_name">{{scope.row.orders_pay_type.type_name}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="100px" align="center" label="收款金额">
          <template slot-scope="scope">
            <span class="link-type">￥{{scope.row.paid_money}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="100px" align="center" label="收款证明">
          <template slot-scope="scope">
            <span class="link-type" v-if="scope.row.orders_pay_proof"
                  @click="handleOpenImage(scope.row.orders_pay_proof.image_url)">
              <img style="height:40px;width:100%;" :src="scope.row.orders_pay_proof.image_url"/></span>
          </template>
        </el-table-column>
        <el-table-column min-width="200px" align="center" label="状态">
          <template slot-scope="scope">
            <el-tag :type="scope.row.status | paymentItemStatusFilter">
              {{scope.row.status|paymentItemStatusTranslator}}
            </el-tag>
          </template>
        </el-table-column>
        <el-table-column align="center" label="操作" width="320" class-name="small-padding">
          <template slot-scope="scope">
            <el-button size="mini" type="danger" @click="handleInnerDelete5(scope.row)"
                       v-if="scope.row.orders_pay_type.id !== 2 && scope.row.status !== 2 && scope.row.status !== 3">删除
            </el-button>
          </template>
        </el-table-column>
      </el-table>
      <el-form :rules="rules1" ref="dataForm" :model="tempactual_pay" label-position="left" label-width="30%"
               style='width: 40%;margin-top:30px;margin-left:60%;text-align: center;'>
        <el-form-item label="订单总金额" prop="actual_pay">
          <div v-if="actualPayEditable">
            <el-input class="edit-input" size="small" v-model="tempactual_pay.actual_pay"></el-input>
            <el-button class='cancel-btn' size="small" icon="el-icon-refresh" type="warning"
                       @click="actualPayEditable = false">取消
            </el-button>
            <el-button type="success" @click="updateActualPayData()" size="small" icon="el-icon-circle-check-outline">
              完成
            </el-button>
          </div>
          <span style="font-size:40px !important;text-align:right;" @click='editactualPay(temp.actual_pay)' v-else>￥{{ temp.actual_pay }}</span>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button v-if="stepStatus=='create'" type="primary" @click="innerTableVisible5 = false">完成</el-button>
        <el-button v-else type="primary" @click="innerTableVisible5 = false">确 定</el-button>
      </div>
    </el-dialog>
    <el-dialog :title="textMap[dialogStatus]" :visible.sync="innerDialogFormVisible5" width="50%">
      <el-form :rules="innerRules5" ref="innerDataForm5" :model="innerTemp5" label-position="left" label-width="160px"
               style='width: 80%; margin-left:10%;'>
        <el-form-item label="付款方式" prop="orders_pay_type_id">
          <el-select v-model="innerTemp5.orders_pay_type_id"
                     @focus="queryOrderPayTypeList(' ')"
                     filterable
                     style="width: 100%"
                     :disabled="payTypeDisabled"
                     remote
                     :remote-method="queryOrderPayTypeList"
                     :loading="payTypeLoading"
                     placeholder="请选择付款方式"
                     @change="handleChangePayType">
            <el-option
              v-for="item in payTypeOptions"
              :key="item.id"
              :label="item.type_name"
              :value="item.id">
            </el-option>
          </el-select>
        </el-form-item>
        <el-form-item label="付款金额" prop="paid_money">
          <el-input v-model="innerTemp5.paid_money" :disabled="paidMoneyEnabled"></el-input>
        </el-form-item>
        <el-form-item label="付款凭证" prop="address"
                      v-if="innerTemp5.orders_pay_type_id && innerTemp5.orders_pay_type_id !== -1 && innerTemp5.orders_pay_type_id !== 1 && innerTemp5.orders_pay_type_id !==2">
          <span v-if="payProofImageUrl">
            <img style="width: 100%" :src="payProofImageUrl"/><br>
          </span>
          <el-button type="primary"
                     style="width: 100%"
                     icon="el-icon-picture"
                     @click="handleOpenPayProof">选择付款凭证
          </el-button>
        </el-form-item>
      </el-form>
      <div slot="footer" class="dialog-footer">
        <el-button @click="innerDialogFormVisible5 = false">取 消</el-button>
        <el-button v-if="dialogStatus=='create'" :loading="btnLoading" type="primary" @click="createInnerData5">确 定
        </el-button>
        <el-button v-else type="primary" @click="updateInnerData5">确 定</el-button>
      </div>
    </el-dialog>
    <el-dialog :visible.sync="innerTablePayProofVisible" width="80%">
      <div class="filter-container" align="right">
        <div class="filter-item">
          <div class="filter-label">打款金额</div>
          <el-input style="width: 150px;" size="small" v-model="payProofQuery.paid_money">
          </el-input>
        </div>
        <el-button align="right" class="filter-item" style="margin-left: 10px;" @click="handleOpenPayProof"
                   type="primary" icon="el-icon-edit">筛选
        </el-button>
      </div>
      <el-table :key='tableKey' :data="ordersPayProofList" v-loading="listLoading" element-loading-text="给我一点时间" border
                fit highlight-current-row
                style="width: 100%" stripe>
        <el-table-column align="center" label="序号" width="65">
          <template slot-scope="scope">
            <span>{{scope.row.id}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="120px" align="center" label="付款方式">
          <template slot-scope="scope">
            <span class="link-type">{{scope.row.orders_pay_type.type_name}}</span>
          </template>
        </el-table-column>
        <el-table-column min-width="100px" align="center" label="付款金额">
          <template slot-scope="scope">
            <span class="link-type" style="font-size: 20px">¥ {{scope.row.paid_money}}</span>
          </template>
        </el-table-column>
        <el-table-column width="200px" align="center" label="凭证图片">
          <template slot-scope="scope">
            <span class="link-type" @click="handleOpenImage(scope.row.image_url)">
              <img style="height:100%;width:100%;" :src="scope.row.image_url"/>
            </span>
          </template>
        </el-table-column>
        <el-table-column min-width="180px" align="center" label="上传时间">
          <template slot-scope="scope">
            <span>{{scope.row.created_at}}</span>
          </template>
        </el-table-column>
        <el-table-column align="center" label="操作" min-width="120" class-name="small-padding">
          <template slot-scope="scope">
            <el-button type="primary" size="mini" @click="handleSelectPayProof(scope.row)">选择</el-button>
          </template>
        </el-table-column>
      </el-table>
    </el-dialog>
    <el-dialog :visible.sync="imageDialogVisible">
      <img width="100%" :src="publicImageUrl">
    </el-dialog>
    <el-dialog :visible.sync="tableDialogVisible" width="80%">
      <el-table :stripe="true" :key='tableKey3' :data="list1" v-loading="listLoading" element-loading-text="给我一点时间"
                border fit highlight-current-row
                style="width: 100%">
        <el-table-column align="center" label="时间" width="165px">
          <template slot-scope="scope">
            <span>{{scope.row.created_at}}</span>
          </template>
        </el-table-column>
        <el-table-column width="100px" align="center" label="产品">
          <template slot-scope="scope">
            <span class="link-type">{{scope.row.product.product_name}}</span>
          </template>
        </el-table-column>
        <el-table-column width="100px" align="center" label="金额">
          <template slot-scope="scope">
            <span>{{scope.row.actual_pay}}</span>
          </template>
        </el-table-column>
        <el-table-column align="center" label="备注">
          <template slot-scope="scope">
            <span v-for="(item1, index) in scope.row.orders_remarks" :key="item1.id">{{item1.remark}}<br></span>
          </template>
        </el-table-column>
      </el-table>
      <div v-show="!listLoading" class="pagination-container">
        <el-pagination background @size-change="handleSizeChange1" @current-change="handleCurrentChange1"
                       :current-page.sync="listQuery1.page"
                       :page-sizes="[5,10,20,30, 50]" :page-size="listQuery1.page_size"
                       layout="total, sizes, prev, pager, next, jumper" :total="total1">
        </el-pagination>
      </div>
    </el-dialog>
    <el-dialog :visible.sync="innerDialogOrderDetailVisible" width="40%">
      <el-card>
        <div slot="header" class="clearfix">
          <span>确认单详情</span>
        </div>
        <h4>基本信息</h4>
        <p class="data-items">
          出单客服: {{ temp.support_member.nickname }}
        </p>
        <p class="data-items">
          出单微信号: {{ temp.product_weixin.info + '(' + temp.product_weixin.weixin_account + ')' }}
        </p>
        <p class="data-items">
          加粉时间: {{ temp.fans_join_time.slice(0,10) }}
        </p>
        <h4>客户信息</h4>
        <p class="data-items">
          姓名: {{ temp.orders_receiver_info.receive_name }}
        </p>
        <p class="data-items">
          电话: {{ temp.orders_receiver_info.phone }}
        </p>
        <p class="data-items">
          收货地址: {{ temp.orders_receiver_info.province_name + temp.orders_receiver_info.city_name +
          (temp.orders_receiver_info.district_name !== undefined ? temp.orders_receiver_info.district_name : '') +
          temp.orders_receiver_info.address}}
        </p>
        <h4>商品明细 <span v-if="temp.orders_warehouse">({{temp.orders_warehouse.name}})</span></h4>
        <p v-for="item in temp.orders_items" class="data-items">
          {{item.product_goods.goods_name}} x {{item.number}}
          <span
            v-if="item.product_goods.unit !== '0' && item.product_goods.unit !== null">({{item.product_goods.unit}})</span>
        </p>
        <h4>支付明细 (订单总额:{{temp.actual_pay}})</h4>
        <p v-for="item in temp.orders_payment.orders_payment_items" v-if="item.status !== 2" class="data-items">
          {{item.orders_pay_type.type_name}}: {{item.paid_money}}
        </p>
      </el-card>
      <div slot="footer" class="dialog-footer">
        <el-button @click="innerDialogOrderDetailVisible = false">取 消</el-button>
        <el-button :loading="btnLoading" type="primary" @click="handleCheckOrders">确 定</el-button>
      </div>
    </el-dialog>
    <el-dialog :visible.sync="innerDialogDistributionInfoVisible" width="40%">
      <el-card v-for="(item, index) in distribution_info" :key="index" v-if="distribution_info !== undefined && distribution_info !== null">
        <div slot="header" class="clearfix">
          <span>{{item.goods_name}}</span>
        </div>
        <h4>首购返佣(和复购互斥)</h4>
        <p class="data-items" v-if="item.distribution !== undefined && item.distribution.first !== undefined">
          {{ item.distribution.first.nickname }}: <span style="color:red;">{{ item.distribution.first.purchase }}</span>
        </p>
        <h4>复购返佣(和首购互斥)</h4>
        <p class="data-items" v-if="item.distribution !== undefined && item.distribution.repeat !== undefined">
          {{ item.distribution.repeat.nickname }}: <span style="color:red;">{{ item.distribution.repeat.purchase }}</span>
        </p>
        <h4>级差返佣</h4>
        <div v-if="item.distribution !== undefined && item.distribution.unequal !== undefined">
          <p v-for="it in item.distribution.unequal" class="data-items">
            {{it.nickname}}: <span style="color:red;">{{it.purchase}}</span>
          </p>
        </div>
        <h4>平级推荐</h4>
        <div v-if="item.distribution !== undefined && item.distribution.equal !== undefined">
          <p v-for="it in item.distribution.equal" class="data-items">
            {{it.nickname}}: <span style="color:red;">{{it.purchase}}</span>
          </p>
        </div>
      </el-card>
    </el-dialog>

    <svg xmlns="http://www.w3.org/2000/svg" version="1.1" height="0">
      <defs>
        <filter id="f1">
          <feGaussianBlur stdDeviation="3"/>
        </filter>
      </defs>
    </svg>
  </div>
</template>

<script>
  import {getProductList} from '@/api/product'
  import {getSupportGroupList} from '@/api/support_member'
  import {getSupportMemberList} from '@/api/support_member'
  import {getProductGoodsList} from '@/api/product_goods'
  // import { getSystemGlobalSettingInfo } from '@/api/system_global_setting'
  import {
    getOrdersShopList,
    getOrdersList,
    createOrders,
    updateOrders,
    createOrdersItem,
    updateOrdersItem,
    deleteOrdersItem,
    deleteOrdersRemark,
    createOrdersRemark,
    updateOrdersLogistics,
    getOrdersLogisticsTypeList,
    getOrdersPayTypeList,
    createOrdersPaymentItem,
    updateOrdersPaymentItem,
    deleteOrdersPaymentItem,
    getOrdersPayProofList,
    getOrdersLogsList,
    getOrdersAreaList,
    createUnidentifyReceiverInfo,
    parseAddress,
    resultOrders,
    destroyOrders,
    checkOrders,
    uncheckOrders,
    getWarehouseList,
    getOrdersItemList,
    getDirectPromotionRefundInfo,
    updateDirectPromotionRefund,
    createDirectPromotionRefund,
    updateOrdersActualPay,
    getOrdersShopDistributionInfo
  } from '@/api/orders'
  import {getProductWeixinList, getProductWeixinFansList} from '@/api/product_weixin'
  import waves from '@/directive/waves' // 水波纹指令
  import Multiselect from 'vue-multiselect'// 使用的一个多选框组件，element-ui的select不能满足所有需求
  import 'vue-multiselect/dist/vue-multiselect.min.css'// 多选框组件css
  // import { regionData, CodeToText } from 'element-china-area-data'
  import {mapGetters} from 'vuex'
  import bus from '@/views/layout/bus'
  import {parseTime} from '@/utils/index'
  import Sticky from '@/components/Sticky'

  export default {
    name: 'ordersManage',
    components: {
      Multiselect,
      Sticky
    },
    directives: {
      waves
    },
    data() {
      const validatePhone = (rule, value, callback) => {
        const myreg = /^[1][1,2,3,4,5,6,7,8,9,0][0-9]{9}$/
        if (!myreg.test(this.innerTemp4.phone)) {
          callback(new Error('请输入正确的手机号'))
        } else {
          callback()
        }
      }
      const validate = (rule, value, callback) => {
        if (!value) {
          callback(new Error('输入'))
        }
        if (/^\d+(\.\d+)?$/.test(value)) {
          callback()
        } else {
          callback(new Error('输入数字'))
        }
      }
      return {
        tableLoading: '',
        show: true,
        scrollTop: 0,
        ifExpandAll: false,
        tableKey: 0,
        hideTableHeader: false,
        tableKey2: 0,
        productListLoading: false,
        productListOptions: [],
        tableKey3: 1,
        list: null,
        orders_items: [],
        ordersItemLoading: false,
        list1: null,
        total: null,
        total1: null,
        listLoading: false,
        chooseId: undefined,
        supportUserAccountLoading: false,
        supportUserAccountOptions: [],
        tempactual_pay: {
          actual_pay: undefined
        },
        listQuery: {
          date_range: '',
          receive_name: '',
          receive_phone: '',
          orders_logistics_number: '',
          orders_unique_id: '',
          orders_shop_unique_id: '',
          created_at: '',
          page: 1,
          page_size: 20,
          weixin_fans_address_receive_name: '',
          weixin_fans_address_phone: '',
          sort: '-id',
          support_member_nickname: '',
          support_user_account_group_id: '',
          support_user_account_id: undefined,
          product_weixin_id: '',
          product_id: undefined,
          status: '',
          remark: ''
        },
        tabSelection: 'all',
        listQuery1: {
          date_range: '',
          page: 1,
          page_size: 5,
          product_weixin_id: undefined
        },
        props: {
          value: 'area_number',
          label: 'area_name',
          children: 'children'
        },
        btnLoading: false,
        warehouseLoading: false,
        warehouseOptions: [],
        allWarehouseOptions: [],
        productDeliverExtraOptions: [],
        productDeliverExtraLoading: false,
        productDeliverLoading: false,
        productDeliverOptions: [],
        queryLogisticsTypeOptions: [],
        queryLogisticsTypeLoading: false,
        importanceOptions: [1, 2, 3],
        sortOptions: [{label: '按ID升序列', key: '+id'}, {label: '按ID降序', key: '-id'}],
        statusOptions: [
          {key: 1, label: '未确认'},
          {key: 2, label: '待发货'},
          {key: 3, label: '发货中'},
          {key: 4, label: '断货中'},
          {key: 5, label: '已签收'},
          {key: 6, label: '已拒收'},
          {key: 7, label: '已完成'}
        ],
        showAuditor: false,
        productWeixinLoading2: false,
        productWeixinOptions2: [],
        pickerOptions1: {},
        expandList: [],
        userGroupOptions: [],
        userGroupTree: [],
        defaultPropsGroup: {
          children: 'child',
          label: 'group_name',
          value: 'id'
        },
        temp: {
          id: undefined,
          create_orders_type: 1,
          orders_unique_id: '',
          support_user_account_id: undefined,
          product_weixin_id: undefined,
          price_total: undefined,
          actual_pay: 0.00,
          status: 1,
          warehouse_id: undefined,
          deliver_date: new Date(),
          orders_items: [],
          support_member: {
            id: undefined,
            user_id: undefined,
            nickname: '',
            head_img: '',
            user_account_type_id: undefined,
            user_account_group_id: undefined,
            user_account_role_id: undefined,
            status: undefined
          },
          product_weixin: {
            id: undefined,
            weixin_nickname: '',
            weixin_account: '',
            info: ''
          },
          orders_receiver_info: {
            id: undefined,
            city: '',
            province: '',
            district: '',
            city_name: '',
            district_name: '',
            province_name: '',
            receive_name: '',
            address: '',
            phone: '',
            postcode: '',
            remark: '',
            regions: []
          },
          product_weixin_fans: {
            id: undefined,
            product_weixin_id: undefined,
            weixin_account: '',
            product_weixin: {}
          },
          orders_remarks: [],
          orders_payment: {
            id: undefined,
            orders_id: undefined,
            payment_total: undefined,
            status: 1,
            orders_payment_items: []
          },
          orders_logistics: {
            id: undefined,
            logistics_type_id: undefined,
            logistics_name: '',
            logistics_number: '',
            orders_logistics_type: {
              code: ''
            }
          },
          fans_join_time: ''
        },
        tempOrdersPaymentItem: {
          id: undefined,
          orders_payment_id: undefined,
          paid_money: undefined,
          pay_type_id: undefined,
          pay_proof_id: undefined,
          created_at: '',
          orders_pay_type: {
            id: undefined,
            type_name: ''
          }
        },
        tempOrderRemark: {
          id: undefined,
          orders_id: undefined,
          user_account_id: undefined,
          user_account_type_id: undefined,
          remark: '',
          created_at: ''
        },
        tempOrdersItem: {
          id: undefined,
          product_id: undefined,
          orders_id: undefined,
          number: undefined,
          product: {
            id: undefined,
            product_name: '',
            price: undefined,
            stock: undefined,
            is_promote: undefined
          }
        },
        payProofQuery: {
          paid_money: undefined
        },
        dialogFormVisible: false,
        dialogStatus: '',
        textMap: {
          update: '编辑',
          create: '创建'
        },
        // rules: {
        //   product_name: [{ required: true, message: '请正确填写商品名称', trigger: 'change' }],
        //   warehouse_id: [{ required: true, message: '选择仓库', trigger: 'change' }],
        //   support_member: {
        //     id: [{ required: true, message: '选择客服', trigger: 'change' }]
        //   },
        //   product_weixin: {
        //     id: [{ required: true, message: '选择推广微信', trigger: 'change' }]
        //   },
        //   product_weixin_fans: {
        //     id: [{ required: true, message: '选择粉丝微信', trigger: 'change' }]
        //   },
        //   deliver_date: [{ required: true, message: '选择发货时间', trigger: 'change' }]
        // },
        rules1: {
          actual_pay: [
            {validator: validate, trigger: 'change'}
          ]
        },
        innerList1: null,
        innerTotal1: null,
        innerTableKey1: 1,
        innerTableTitle1: '',
        innerListQuery1: {
          page: 1,
          page_size: 5,
          product_id: undefined,
          sort: '-id'
        },
        innerTemp1: {
          id: undefined,
          product_goods: {
            id: undefined
          },
          warehouse_id: undefined,
          number: ''
        },
        innerListLoading1: false,
        innerTableVisible1: false,
        innerDialogFormVisible1: false,
        innerRules4: {
          phone: [{required: true, trigger: 'blur', validator: validatePhone}]
        },
        innerRules1: {
          number: [{required: true, trigger: 'change', validator: validate}],
          product_goods: {
            id: [{required: true, trigger: 'change', message: '选择产品'}]
          }
        },
        innerList2: null,
        innerTotal2: null,
        innerTableKey2: 2,
        innerTableTitle2: '',
        innerListQuery2: {
          page: 1,
          page_size: 5,
          product_id: undefined,
          sort: '-id'
        },
        innerTemp2: {
          id: undefined,
          product: undefined,
          number: ''
        },
        innerListLoading2: false,
        innerTableVisible2: false,
        innerDialogFormVisible2: false,
        innerRules2: {
          remark: [{required: true, message: '输入备注信息内容', trigger: 'change'}]
        },
        innerListLoading3: false,
        innerTableVisible3: false,
        innerTableTitle3: '',
        innerTableKey3: 3,
        innerList3: null,
        innerTotal3: null,
        innerListQuery3: {
          page: 1,
          page_size: 10,
          sort: '-id',
          orders_id: undefined
        },
        innerTemp3: {
          id: undefined,
          logistics_type_id: undefined,
          product_deliver_extra_id: undefined,
          logistics_name: '',
          logistics_number: '',
          product_deliver_id: undefined,
          dest_code: '',
          dest_extra_code: '',
          orders_logistics_type: {
            code: '',
            id: '',
            name: ''
          }
        },
        innerDialogFormVisible3: false,
        innerRules3: {
          template_name: [{required: true, message: '请正确填写模板名称', trigger: 'change'}],
          template_code: [{required: true, message: '请正确填写模板内容', trigger: 'change'}]
        },
        innerList5: null,
        innerTotal5: null,
        innerTableKey5: 5,
        innerTableTitle5: '',
        innerListQuery5: {
          page: 1,
          page_size: 5,
          product_id: undefined,
          sort: '-id'
        },
        innerTemp5: {
          id: undefined,
          orders_pay_type: {
            type_name: undefined
          },
          orders_pay_type_id: undefined,
          paid_money: undefined,
          orders_pay_proof_id: undefined
        },
        innerListLoading5: false,
        innerTableVisible5: false,
        innerDialogFormVisible5: false,
        innerRules5: {
          orders_pay_type_id: [{required: true, message: '选择方式', trigger: 'change'}],
          paid_money: [{required: true, message: '输入金额或选择凭证', trigger: 'change'}]
        },
        innerTemp7: {
          orders_id: undefined,
          support_user_account_id: undefined,
          finance_user_account_id: undefined,
          refund_money: undefined,
          receiver_info: undefined,
          status: undefined,
          remark: undefined,
          refund_img_url: undefined
        },
        innerDialogFormVisible7: false,
        btnLoading7: false,
        innerDataForm7: 7,
        innerRules7: {},
        productType: {
          1: '推广',
          2: '附属产品',
          3: '赠品'
        },
        productTypeOptions: [
          {key: 1, display_name: '推广'},
          {key: 2, display_name: '附属产品'},
          {key: 3, display_name: '赠品'}
        ],
        supportMemberOptions: [],
        productWeixinOptions: [],
        productWeixinFansOptions: [],
        productOptions: [],
        productGoodsOptions: [],
        logisticsTypeOptions: [],
        payTypeOptions: [],
        if_deleted: 'deleted-p',
        regionData: [],
        tempProductId: undefined,
        selectedRegionOptions: [],
        // CodeToText: CodeToText,
        publicImageUrl: '',
        imageDialogVisible: false,
        tableDialogVisible: false,
        payTypeLoading: false,
        payProofVisiable: false,
        payProofImageUrl: undefined,
        innerTablePayProofVisible: false,
        ordersPayProofList: [],
        paidMoneyEnabled: false,
        payTypeDisabled: true,
        actualPayEditable: false,
        stepStatus: 'create',
        today_orders: 0,
        need_delivery: 0,
        pickerOptions2: {
          shortcuts: [{
            text: '最近一周',
            onClick(picker) {
              const end = new Date()
              const start = new Date()
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 7)
              picker.$emit('pick', [start, end])
            }
          }, {
            text: '最近一个月',
            onClick(picker) {
              const end = new Date()
              const start = new Date()
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 30)
              picker.$emit('pick', [start, end])
            }
          }, {
            text: '最近三个月',
            onClick(picker) {
              const end = new Date()
              const start = new Date()
              start.setTime(start.getTime() - 3600 * 1000 * 24 * 90)
              picker.$emit('pick', [start, end])
            }
          }]
        },
        delivery_address: '',
        delivery_product_name: '',
        sf_monthly_account: '',
        tempPay: undefined,
        temp_receiver_info: '',
        showReceiverForm: false,
        countNeedManualHandleOrders: 0,
        innerDialogOrderDetailVisible: false,
        innerDialogDistributionInfoVisible: false,
        distribution_info: []
      }
    },
    computed: {
      ...mapGetters([
        'user_account_id',
        'roles'
      ])
    },
    filters: {
      statusUnit(status) {
        const statusTransMap = {
          0: '件',
          1: '斤',
          2: 'g'
        }
        return statusTransMap[status]
      },
      statusFilter(status) {
        const statusMap = {
          1: 'success',
          2: 'info',
          3: 'danger'
        }
        return statusMap[status]
      },
      statusTranslator(status) {
        const statusMap = {
          1: '推广',
          2: '附属产品',
          3: '赠品'
        }
        return statusMap[status]
      },
      orderStatusFilter(status) {
        const statusMap = {
          0: 'info',
          1: 'info',
          2: 'warning',
          3: '',
          4: '',
          5: '',
          6: 'danger',
          7: 'success',
          8: '',
          9: 'danger'
        }
        return statusMap[status]
      },
      orderStatusTranslator(orders) {
        const statusMap = {
          0: '已取消',
          1: '未支付',
          2: '待发货',
          3: '发货中',
          4: '已签收',
          5: '待评价',
          6: '已评价',
          99: '已退回'
        }
        let status = 0
        if (orders.shop_orders_status === 4) {
          status = 0
        } else if (orders.shop_orders_status === 3 && orders.if_pay === 1) {
          status = 1
        } else if (orders.shop_orders_status === 3 && orders.if_pay === 2 && orders.if_received === 0) {
          status = 2
        } else if (orders.shop_orders_status === 3 && orders.if_pay === 2 && orders.if_received === 1) {
          status = 3
        } else if (orders.shop_orders_status === 3 && orders.if_pay === 2 && orders.if_received === 2) {
          status = 4
        } else if (orders.shop_orders_status === 5) {
          status = 99
        }

        return statusMap[status]
      },
      orderStatusTranslator2(status) {
        const statusMap = {
          0: '无效订单',
          1: '未确认',
          2: '待发货',
          3: '发货中',
          4: '断货中',
          5: '已签收',
          6: '已拒收',
          7: '已完成',
          8: '已退回',
          9: '废弃',
          10: '已退款'
        }
        return statusMap[status]
      },
      paymentItemStatusFilter(status) {
        const statusMap = {
          0: 'info',
          1: 'success',
          2: 'danger',
          3: ''
        }
        return statusMap[status]
      },
      paymentItemStatusTranslator(status) {
        const statusMap = {
          0: '未确认',
          1: '已确认',
          2: '已删除',
          3: '已提现'
        }
        return statusMap[status]
      },
      userTypeStatusTranslator(status) {
        const statusMap = {
          1: '推广',
          2: '客服',
          3: '文案',
          4: '库管',
          5: '管理员'
        }
        return statusMap[status]
      },
      orderPhoneVisibleTranslator(phone) {
        // this.$store.state.user.roles
        if (phone) {
          return phone.substr(0, 3) + '****' + phone.substr(7)
        } else {
          return phone
        }
      }
    },
    created() {
      this.getList()
      // this.getUserGroupTree()
      // this.getProductWeixinList(' ')
      // this.queryOrderPayTypeList(' ')
      // this.getNeedManualHandleOrdersCountInfo()
      // this.getWarehouseList(0)
      // this.getAllWarehouseList()
      // this.getSystemDeliveryAddress()
      // this.getSystemDeliveryProductName()
      // this.getSystemSfMonthlyAccount()
      // this.getregionData()
    },
    methods: {
      getOrdersShopDistributionInfo(orders_shop_id) {
        this.innerDialogDistributionInfoVisible = true
        getOrdersShopDistributionInfo({ orders_shop_id: orders_shop_id }).then(response => {
          this.distribution_info = response.data.distribution_info
        })
      },
      getOrdersDetail(row) {
        this.$router.push({
          path: '/orders/ordersDetail/',
          query: {
            orders_id: row.id
          }
        })
      },
      gotoDetail(id) {
        console.log(this.$router)
        this.$router.push({
          name: 'ordersDetails',
          params: {id: id}
        })
      },
      resetWarehouse() {
        this.temp.warehouse_id = undefined
        this.warehouseOptions = []
        this.getWarehouseList(this.temp.product_weixin.finance_group_id)
      },
      resetWarehouse2() {
        this.temp.warehouse_id = undefined
        this.warehouseOptions = []
        this.getWarehouseList(this.temp.product_weixin_fans.product_weixin.finance_group_id)
      },
      handleUnidenfyReceiverInfo() {
        createUnidentifyReceiverInfo({content: this.temp_receiver_info}).then(() => {
          this.$notify({
            title: '成功',
            message: '感谢你对完善系统做的贡献, 技术正在努力修改中',
            type: 'success',
            duration: 5000
          })
        })
      },
      handleClick(tab, event) {
        this.listQuery.status = ''
        if (tab.name !== 'all') {
          this.listQuery.status = parseInt(tab.name)
        }
        this.getList()
      },
      rowStyle1() {
        return 'min-height: 160px;'
      },
      cellStyle1({row, column, rowIndex, columnIndex}) {
        if (columnIndex === 0) {
          return 'padding: 0px;border-bottom:none;'
        }
        // if (columnIndex === 1) {
        //   return 'border-left:2px solid #ebeef5;'
        // }
      },
      cellStyle2({row, column, rowIndex, columnIndex}) {
        if (columnIndex === 0) {
          return 'border-right:none;'
        }
      },
      smartParse() {
        parseAddress({receiver_info: this.temp_receiver_info}).then(response => {
          this.showReceiverForm = true
          this.temp.orders_receiver_info.receive_name = response.data.name
          this.temp.orders_receiver_info.phone = response.data.mobile
          this.temp.orders_receiver_info.regions = [parseInt(response.data.detail.province), parseInt(response.data.detail.city), parseInt(response.data.detail.district)]
          this.temp.orders_receiver_info.address = response.data.detail.address
        })
      },
      editactualPay(val) {
        this.tempactual_pay.actual_pay = val
        this.actualPayEditable = true
      },
      getUserGroupTree() {
        getSupportGroupList().then(response => {
          this.userGroupTree = this.formatUserGroupTree(response.data)
        })
      },
      formatUserGroupTree(tree) {
        const Group = tree.map(item => {
          if (item.child.length > 0) {
            item.child = this.formatUserGroupTree(item.child)
            return item
          } else {
            delete item.child
            return item
          }
        })
        return Group
      },
      getSupportUserAccountList(query) {
        if (query !== '') {
          this.supportUserAccountLoading = true
          getSupportMemberList({nickname: query, status: 1}).then(response => {
            this.supportUserAccountOptions = response.data.data
            this.supportUserAccountLoading = false
          })
        }
      },
      handleFilterGrounp(val) {
        this.listQuery.support_user_account_group_id = val[val.length - 1]
        this.handleFilter()
      },
      getregionData() {
        getOrdersAreaList().then(response => {
          this.regionData = response.data
        })
      },
      refreshOrdersList() {
        this.getNeedManualHandleOrdersCountInfo()
        this.getList()
      },
      getNeedManualHandleOrdersCountInfo() {
        const tempParams = Object.assign({}, this.listQuery)
        tempParams.status = 3
        tempParams.need_manual_handle = 1
        getOrdersList(tempParams).then(response => {
          this.countNeedManualHandleOrders = response.data.total
        })
      },
      handleChangePayType(value) {
        if (value !== -1 && value !== 1 && value !== 2) {
          this.payProofVisiable = true
          this.paidMoneyEnabled = true
        } else {
          this.payProofVisiable = false
          this.paidMoneyEnabled = false
        }
        this.innerTemp5.paid_money = undefined
        this.payProofImageUrl = undefined
        this.innerTemp5.orders_pay_proof_id = undefined
      },
      queryOrderPayTypeList(query) {
        if (query !== '') {
          this.payTypeLoading = true
          getOrdersPayTypeList({type_name: query}).then(response => {
            this.payTypeOptions = response.data
            this.payTypeLoading = false
          })
        }
      },
      getProductWeixinList(query) {
        if (query !== '') {
          this.productWeixinLoading2 = true
          getProductWeixinList({info: query}).then(response => {
            this.productWeixinOptions2 = response.data.data
            this.productWeixinLoading2 = false
          })
        }
      },
      handleAddressRowClick(row, column, cell, event) {
        if (cell.cellIndex === 3) {
          this.temp.product_weixin_fans_address_id = row.id
        }
        this.innerTemp4 = Object.assign({}, row) // copy obj
      },
      handleRegionChange(value) {
      },
      tableRowClassName({row, rowIndex}) {
        return 'colored-row'
      },
      querySupportMemberList(query) {
        getSupportMemberList({nickname: query, user_account_type_code: 'support', status: '1'}).then(response => {
          if (!response.data.data) return
          this.supportMemberOptions = response.data.data
        })
      },
      queryProductWeixinList(query) {
        if (!this.temp.support_member.id) {
          this.$message({
            type: 'info',
            message: '请先选择客服'
          })
          return
        }
        const tempData = {}
        tempData.weixin_account = query
        if ((this.$store.state.user.roles === 'administrator') || (this.$store.state.user.roles === 'supportDirector') || (this.$store.state.user.roles === 'supportManager')) {
          // alert(this.$store.state.user.roles)
        } else {
          tempData.support_user_account_id = this.temp.support_member.id
        }
        getProductWeixinList(tempData).then(response => {
          if (!response.data.data) return
          this.productWeixinOptions = response.data.data
          for (const v of this.productWeixinOptions) {
            v.weixin_account = v.weixin_account + '  (' + v.info + ')'
            const index = this.productWeixinOptions.indexOf(v)
            this.productWeixinOptions.splice(index, 1, v)
          }
        })
      },
      getProductList(query) {
        if (query !== '') {
          this.productListLoading = true
          getProductList({product_name: query, is_promote: 1}).then(response => {
            this.productListOptions = response.data.data
            this.productListLoading = false
          })
        }
      },
      getWarehouseList(finance_group_id) {
        this.warehouseLoading = true
        getWarehouseList({finance_group_id: finance_group_id}).then(response => {
          this.warehouseOptions = response.data.data
          if (this.warehouseOptions.length === 1) {
            this.temp.warehouse_id = this.warehouseOptions[0].id
          }
          this.warehouseLoading = false
        })
      },
      getAllWarehouseList() {
        getWarehouseList().then(response => {
          this.allWarehouseOptions = response.data.data
        })
      },
      queryProductWeixinFansList(query) {
        getProductWeixinFansList({
          fans_weixin_account: query
        }).then(response => {
          if (!response.data.data) return
          this.productWeixinFansOptions = response.data.data
        })
      },
      queryProductList(query) {
        getProductList({product_name: query}).then(response => {
          if (!response.data.data) return
          this.productOptions = response.data.data
        })
      },
      queryProductGoodsList(query) {
        getProductGoodsList({goods_name: query, page_size: 40, is_sale: 1, orders_id: this.temp.id}).then(response => {
          this.productGoodsOptions = response.data.data
        })
      },
      queryLogisticsTypeList(query) {
        if (this.innerTemp3.product_deliver_id === undefined || this.innerTemp3.product_deliver_id === '') {
          this.$message.error('先选择仓库')
          return
        }
        if (query !== '') {
          this.queryLogisticsTypeLoading = true
          getOrdersLogisticsTypeList({
            logistics_name: query,
            product_deliver_id: this.innerTemp3.product_deliver_id
          }).then(response => {
            this.logisticsTypeOptions = response.data.data
            this.queryLogisticsTypeLoading = false
          })
        }
      },
      resetSupportMember() {
        this.temp.product_weixin_id = undefined
        this.productWeixinOptions = []
        this.temp.product_weixin = {
          id: undefined,
          product_id: undefined,
          promotion_user_account_id: undefined,
          support_user_account_id: undefined,
          promotion_channel_id: undefined,
          weixin_nickname: '',
          weixin_account: '',
          phone: '',
          qq: '',
        }
      },
      resetProductWeixinFans() {
        this.temp.product_weixin_fans_address_id = undefined
        this.temp.product_weixin_fans_address = {
          id: undefined,
          product_weixin_fans_id: undefined,
          receive_name: '',
          phone: '',
          postcode: '',
          address: '',
          remark: ''
        }
      },
      getList() {
        this.tableLoading = 'filtered'
        getOrdersShopList(this.listQuery).then(response => {
          this.list = response.data.data
          console.log(this.list)
          this.total = response.data.total
          this.tableLoading = ''
        })
      },
      handleFilter() {
        this.listQuery.page = 1
        // this.getNeedManualHandleOrdersCountInfo()
        this.getList()
      },
      handleSizeChange(val) {
        this.listQuery.page_size = val
        this.getList()
        window.scrollTo(0, 0)
      },
      handleSizeChange1(val) {
        this.listQuery1.page_size = val
        this.getList2()
      },
      handleCurrentChange(val) {
        this.listQuery.page = val
        this.getList()
        window.scrollTo(0, 0)
      },
      handleCurrentChange1(val) {
        this.listQuery1.page = val
        this.getList2()
      },
      handleModifyStatus(row, status) {
        uncheckOrders({orders_id: row.id, status: status}).then(() => {
          this.$message({
            message: '取消订单成功',
            type: 'success'
          })
          this.getList()
        })
      },
      handleCheckOrders() {
        const row = this.temp
        this.$confirm('确认订单信息无误', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          checkOrders({orders_id: row.id}).then(res => {
            this.getList()
            this.$message.success('确认订单成功')
            this.innerDialogOrderDetailVisible = false
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消'
          })
        })
      },
      handleOpenOrdersDetail(row) {
        this.temp = Object.assign({}, row)
        this.innerDialogOrderDetailVisible = true
      },
      handleResultOrders(row) {
        const tempParms = {
          orders_id: row.id
        }
        resultOrders(tempParms).then(res => {
          row.status = 7
        })
      },
      handleDestoryOrders(row) {
        this.$confirm('此操作将永久删除该订单, 是否继续?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          const tempParms = {
            orders_id: row.id
          }
          destroyOrders(tempParms).then(res => {
            this.getList()
          }).catch(() => {
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          })
        })
      },
      resetTemp() {
        this.showReceiverForm = false
        this.temp_receiver_info = ''
        this.temp = {
          id: undefined,
          create_orders_type: 1,
          orders_unique_id: '',
          support_user_account_id: undefined,
          product_weixin_id: undefined,
          price_total: undefined,
          actual_pay: 0.00,
          status: 1,
          warehouse_id: undefined,
          deliver_date: new Date(),
          orders_items: [],
          support_member: {
            id: undefined,
            user_id: undefined,
            nickname: '',
            head_img: '',
            user_account_type_id: undefined,
            user_account_group_id: undefined,
            user_account_role_id: undefined,
            status: undefined
          },
          product_weixin: {
            id: undefined,
            weixin_nickname: '',
            weixin_account: '',
            info: ''
          },
          orders_receiver_info: {
            id: undefined,
            city: '',
            province: '',
            district: '',
            city_name: '',
            district_name: '',
            province_name: '',
            receive_name: '',
            address: '',
            phone: '',
            postcode: '',
            remark: '',
            regions: []
          },
          product_weixin_fans: {
            id: undefined,
            product_weixin_id: undefined,
            weixin_account: '',
            product_weixin: {}
          },
          orders_remarks: [],
          orders_payment: {
            id: undefined,
            orders_id: undefined,
            payment_total: undefined,
            status: 1,
            orders_payment_items: []
          },
          orders_logistics: {
            id: undefined,
            logistics_type_id: undefined,
            logistics_name: '',
            logistics_number: '',
            orders_logistics_type: {
              code: ''
            }
          },
          fans_join_time: ''
        }
        // if (this.$store.state.user.roles === 'support') {
        //   this.temp.support_member.id = this.$store.state.user.user_account_id
        //   this.temp.support_member.nickname = this.$store.state.user.name
        // }
      },
      handleCreate() {
        this.resetTemp()
        this.stepStatus = 'create'
        this.dialogStatus = 'create'
        this.dialogFormVisible = true
        this.$nextTick(() => {
          this.$refs['dataForm1'].clearValidate()
        })
      },
      createData() {
        this.$refs['dataForm1'].validate((valid) => {
          if (valid) {
            this.btnLoading = true
            this.temp.support_user_account_id = this.temp.support_member.id
            if (this.temp.create_orders_type === '1') {
              this.temp.product_weixin_fans_id = this.temp.product_weixin_fans.id
            } else {
              this.temp.product_weixin_id = this.temp.product_weixin.id
            }
            this.temp.receive_name = this.temp.orders_receiver_info.receive_name
            this.temp.phone = this.temp.orders_receiver_info.phone
            this.temp.address = this.temp.orders_receiver_info.address
            this.temp.province = this.temp.orders_receiver_info.regions[0]
            this.temp.city = this.temp.orders_receiver_info.regions[1]
            this.temp.district = this.temp.orders_receiver_info.regions[2]
            createOrders(this.temp).then(response => {
              this.btnLoading = false
              this.getList()
              this.dialogFormVisible = false
            }).catch(() => {
              this.btnLoading = false
            })
          }
        })
      },
      handleUpdate(row) {
        this.stepStatus = 'update'
        this.temp_receiver_info = ''
        this.temp = Object.assign({}, row) // copy obj
        this.dialogStatus = 'update'
        this.dialogFormVisible = true
        this.showReceiverForm = true
        this.temp.orders_receiver_info.regions = [
          parseInt(this.temp.orders_receiver_info.province),
          parseInt(this.temp.orders_receiver_info.city),
          parseInt(this.temp.orders_receiver_info.district)
        ]
        this.$nextTick(() => {
          this.$refs['dataForm1'].clearValidate()
        })
      },
      updateData() {
        this.$refs['dataForm1'].validate((valid) => {
          if (valid) {
            this.temp.receive_name = this.temp.orders_receiver_info.receive_name
            this.temp.phone = this.temp.orders_receiver_info.phone
            this.temp.address = this.temp.orders_receiver_info.address
            this.temp.province = this.temp.orders_receiver_info.regions[0]
            this.temp.city = this.temp.orders_receiver_info.regions[1]
            this.temp.district = this.temp.orders_receiver_info.regions[2]
            const tempData = Object.assign({}, this.temp)
            tempData.orders_id = this.temp.id
            tempData.support_user_account_id = this.temp.support_member.id
            if (this.temp.product_weixin) {
              tempData.product_weixin_id = this.temp.product_weixin.id
            }
            if (this.temp.product_weixin_fans) {
              tempData.product_weixin_fans_id = this.temp.product_weixin_fans.id
            }
            updateOrders(tempData).then(() => {
              this.getList()
              this.dialogFormVisible = false
              this.$notify({
                title: '成功',
                message: '更新成功',
                type: 'success',
                duration: 2000
              })
            })
          }
        })
      },
      handleCashOnDeliveryPaidMoney() {
        let totalPayMoney = 0.00
        console.log(this.temp.orders_payment.orders_payment_items)
        for (const v of this.temp.orders_payment.orders_payment_items) {
          if (v.orders_pay_type.type_code !== 'cash_on_delivery' && (v.status !== 2)) {
            totalPayMoney += parseFloat(v.paid_money)
          }
        }
        let cashOnDeliveryPaidMoney = this.temp.actual_pay - totalPayMoney
        cashOnDeliveryPaidMoney = (cashOnDeliveryPaidMoney > 0) ? cashOnDeliveryPaidMoney : 0.00
        for (const v of this.temp.orders_payment.orders_payment_items) {
          if (v.orders_pay_type.type_code === 'cash_on_delivery') {
            v.paid_money = cashOnDeliveryPaidMoney
            const index = this.temp.orders_payment.orders_payment_items.indexOf(v)
            this.temp.orders_payment.orders_payment_items.splice(index, 1, v)
          }
        }
      },
      updateActualPayData() {
        this.$refs['dataForm'].validate((valid) => {
          if (valid) {
            this.temp.actual_pay = this.tempactual_pay.actual_pay
            const tempData = Object.assign({}, this.temp)
            tempData.orders_id = this.temp.id
            tempData.actual_pay = this.temp.actual_pay
            updateOrdersActualPay(tempData).then(() => {
              this.handleCashOnDeliveryPaidMoney()
              for (const v of this.list) {
                if (v.id === this.temp.id) {
                  const index = this.list.indexOf(v)
                  this.list.splice(index, 1, this.temp)
                  break
                }
              }
              bus.$emit('upDateRealTimeRanking')
              this.actualPayEditable = false
            })
          }
        })
      },
      handleOpenInner1(row) {
        console.log(row)
        this.stepStatus = 'update'
        this.innerTableVisible1 = true
        this.dialogStatus = 'update'
        this.innerTableTitle1 = row.orders_unique_id.slice(-8) + ' 商品列表'
        this.temp = Object.assign({}, row) // copy obj
        this.$nextTick(() => {
          this.getOrdersItemList()
        })
      },
      getOrdersItemList() {
        this.ordersItemLoading = true
        getOrdersItemList({orders_id: this.temp.id}).then(res => {
          this.orders_items = res.data.data
          this.ordersItemLoading = false
          this.innerTableKey1++
        })
      },
      handleInnerFilter1() {
        this.innerListQuery1.page = 1
        this.getInnerList1()
      },
      handleInnerSizeChange1(val) {
        this.innerListQuery1.page_size = val
        this.getInnerList1()
      },
      handleInnerCurrentChange1(val) {
        this.innerListQuery1.page = val
        this.getInnerList1()
      },
      resetInnerTemp1() {
        this.innerTemp1 = {
          id: undefined,
          product_goods: {
            id: undefined
          },
          warehouse_id: undefined,
          product_id: undefined,
          number: ''
        }
      },
      handleInnerCreate1() {
        console.log(this.temp)
        this.resetInnerTemp1()
        this.dialogStatus = 'create'
        this.innerDialogFormVisible1 = true
        this.innerTemp1.product_id = this.temp.id
        this.innerTemp1.warehouse_id = this.temp.warehouse_id
        this.$nextTick(() => {
          this.$refs['innerDataForm1'].clearValidate()
        })
      },
      createInnerData1() {
        this.$refs['innerDataForm1'].validate((valid) => {
          if (valid) {
            this.btnLoading = true
            this.innerTemp1.product_goods_id = this.innerTemp1.product_goods.id
            // this.innerTemp1.product_goods_storage_id = this.innerTemp1.product_common.id
            this.innerTemp1.orders_id = this.temp.id
            createOrdersItem(this.innerTemp1).then(res => {
              this.getOrdersItemList()
              this.getList()
              this.innerDialogFormVisible1 = false
              this.btnLoading = false
              this.$notify({
                title: '成功',
                message: '创建成功',
                type: 'success',
                duration: 2000
              })
            }).catch(() => {
              this.btnLoading = false
            })
          }
        })
      },
      handleInnerUpdate1(row) {
        this.innerTemp1 = Object.assign({}, row) // copy obj
        this.productGoodsOptions = []
        this.productGoodsOptions.push(row.product_goods)
        this.dialogStatus = 'update'
        this.innerDialogFormVisible1 = true
        this.$nextTick(() => {
          this.$refs['innerDataForm1'].clearValidate()
        })
      },
      // 修改订单商品
      updateInnerData1() {
        this.$refs['innerDataForm1'].validate((valid) => {
          if (valid) {
            this.btnLoading = true
            const params = Object.assign({}, this.innerTemp1)
            params.orders_item_id = this.innerTemp1.id
            params.product_goods_id = this.innerTemp1.product_goods.id
            updateOrdersItem(params).then(() => {
              this.getOrdersItemList()
              this.getList()
              this.innerDialogFormVisible1 = false
              this.btnLoading = false
              this.$notify({
                title: '成功',
                message: '更新成功',
                type: 'success',
                duration: 2000
              })
            }).catch(() => {
              this.btnLoading = false
            })
          }
        })
      },
      handleInnerDelete1(row) {
        this.$confirm('确定删除订单商品?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          deleteOrdersItem({orders_item_id: row.id, orders_id: this.temp.id}).then(res => {
            this.$message.success('删除成功')
            this.getOrdersItemList()
            this.getList()
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          })
        })
      },
      handleOpenInner2(row) {
        this.innerTableVisible2 = true
        this.innerTableTitle2 = row.orders_unique_id.slice(-8) + ' -- 备注'
        this.temp = Object.assign({}, row)
        // this.getInnerList1()
      },
      handleInnerSizeChange3(val) {
        this.innerListQuery3.page_size = val
        this.getInnerList3()
      },
      handleInnerCurrentChange3(val) {
        this.innerListQuery3.page = val
        this.getInnerList3()
      },
      getInnerList3() {
        this.innerListQuery3.orders_id = this.temp.id
        this.innerListLoading3 = true
        getOrdersLogsList(this.innerListQuery3).then(response => {
          this.innerList3 = response.data.data
          this.innerTotal3 = response.data.total
          this.innerListLoading3 = false
        })
      },
      handleOpenInner3(row) {
        this.innerTableVisible3 = true
        this.innerTableTitle3 = row.orders_unique_id.slice(-8) + ' -- 订单日志'
        this.temp = Object.assign({}, row) // copy obj
        this.getInnerList3()
      },
      resetInnerTemp2() {
        this.innerTemp2 = {}
      },
      handleInnerCreate2() {
        this.resetInnerTemp2()
        this.dialogStatus = 'create'
        this.innerDialogFormVisible2 = true
        this.$nextTick(() => {
          this.$refs['innerDataForm1'].clearValidate()
        })
      },
      createInnerData2() {
        this.$refs['innerDataForm2'].validate((valid) => {
          if (valid) {
            this.btnLoading = true
            this.innerTemp2.orders_id = this.temp.id
            createOrdersRemark(this.innerTemp2).then(response => {
              this.innerTotal2++
              this.innerTemp2.id = response.data.id
              this.innerTemp2.type_name = response.data.type_name
              this.innerTemp2.status = 1
              this.innerTemp2.type = 1
              this.innerTemp2.updated_at = response.data.updated_at
              this.temp.orders_remarks.push(this.innerTemp2)
              this.innerDialogFormVisible2 = false
              this.btnLoading = false
              this.$notify({
                title: '成功',
                message: '创建成功',
                type: 'success',
                duration: 2000
              })
            }).catch(() => {
              this.btnLoading = false
            })
          }
        })
      },
      handleInnerDelete2(row) {
        this.$confirm('确定删除此备注?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          const ttempData = Object.assign({}, row) // copy obj
          ttempData.orders_remark_id = row.id
          deleteOrdersRemark(ttempData).then(response => {
            this.$notify({
              title: '成功',
              message: '删除成功',
              type: 'success',
              duration: 2000
            })
            ttempData.status = 0
            const index = this.temp.orders_remarks.indexOf(row)
            this.temp.orders_remarks.splice(index, 1, ttempData)
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          })
        })
      },
      resetInnerTemp3() {
        this.innerTemp3 = {
          id: undefined,
          logistics_type_id: undefined,
          product_deliver_extra_id: undefined,
          product_deliver_id: undefined,
          logistics_name: '',
          logistics_number: '',
          orders_logistics_type: {
            id: undefined,
            name: '',
            code: '',
            status: undefined
          }
        }
      },
      handleInnerUpdate3(row) {
        this.logisticsTypeOptions = []
        this.tempProductId = row.product_id
        this.temp = Object.assign({}, row)
        this.dialogStatus = 'update'
        this.innerDialogFormVisible3 = true
        if (row.orders_logistics.id !== 0) {
          this.logisticsTypeOptions.push({
            id: row.orders_logistics.orders_logistics_type.id,
            name: row.orders_logistics.orders_logistics_type.name,
            code: row.orders_logistics.orders_logistics_type.code
          })
          if (row.orders_logistics.product_deliver_extra_id !== null) {
            this.productDeliverExtraOptions = [{
              id: row.orders_logistics.product_deliver_extra.id,
              description: row.orders_logistics.product_deliver_extra.description
            }]
          }
          this.productDeliverOptions = [{
            id: row.orders_logistics.product_deliver.id,
            name: row.orders_logistics.product_deliver.name
          }]
          this.innerTemp3 = Object.assign({}, row.orders_logistics)
        } else {
          this.resetInnerTemp3()
          this.productDeliverOptions = []
          this.logisticsTypeOptions = []
          this.innerTemp3.orders_logistics_type = ''
        }
        this.$nextTick(() => {
          this.$refs['innerDataForm3'].clearValidate()
        })
      },
      createInnerData3() {
        this.$refs['innerDataForm3'].validate((valid) => {
          if (valid) {
            const tempData = this.innerTemp3
            tempData.orders_id = this.temp.id
            tempData.logistics_type_id = this.innerTemp3.orders_logistics_type.id
            updateOrdersLogistics(tempData).then(response => {
              this.temp.orders_logistics = tempData
              this.innerDialogFormVisible3 = false
              this.$notify({
                title: '成功',
                message: '更新成功',
                type: 'success',
                duration: 2000
              })
              const index = this.list.findIndex(d => d.id === this.temp.id)
              this.list[index].orders_logistics = response.data
            })
          }
        })
      },
      handleOpenPayProof() {
        this.innerTablePayProofVisible = true
        this.ordersPayProofList = []
        getOrdersPayProofList({
          paid_money: this.payProofQuery.paid_money,
          is_used: 0,
          pay_type_id: this.innerTemp5.orders_pay_type_id,
          orders_id: this.temp.id
        }).then(response => {
          this.ordersPayProofList = response.data.data
        })
      },
      handleSelectPayProof(row) {
        this.innerTemp5.paid_money = row.paid_money
        this.payProofImageUrl = row.image_url
        this.innerTemp5.orders_pay_proof_id = row.id
        this.innerTablePayProofVisible = false
      },
      handleOpenAnotherInner5(row) {
        console.log(row)
        this.temp = Object.assign({}, row) // copy obj
        this.innerTableVisible5 = true
        this.dialogStatus = 'update'
        this.innerTableTitle5 = row.orders_unique_id.slice(-8) + ' -- 编辑收款信息'
      },
      resetInnerTemp5() {
        this.innerTemp5 = {
          id: undefined,
          orders_pay_type: {
            type_name: undefined
          },
          orders_pay_type_id: undefined,
          paid_money: undefined,
          orders_pay_proof_id: undefined
        }
        this.payProofImageUrl = false
      },
      handleInnerCreate5() {
        this.resetInnerTemp5()
        this.dialogStatus = 'create'
        this.payTypeDisabled = false
        this.innerDialogFormVisible5 = true
        this.innerTemp5.orders_id = this.temp.id
        this.$nextTick(() => {
          this.$refs['innerDataForm5'].clearValidate()
        })
      },
      createInnerData5() {
        this.$refs['innerDataForm5'].validate((valid) => {
          if (valid) {
            this.btnLoading = true
            createOrdersPaymentItem(this.innerTemp5).then(response => {
              this.innerDialogFormVisible5 = false
              this.innerTotal5++
              this.innerTemp5.id = response.data.id
              this.innerTemp5.status = response.data.status
              this.innerTemp5.orders_pay_type_id = response.data.pay_type_id
              this.innerTemp5.orders_pay_proof = response.data.orders_pay_proof
              this.innerTemp5.updated_at = response.data.updated_at
              this.innerTemp5.orders_pay_type.type_name = response.data.orders_pay_type.type_name
              this.temp.orders_payment.orders_payment_items.push(this.innerTemp5)
              this.handleCashOnDeliveryPaidMoney()
              this.$notify({
                title: '成功',
                message: '创建成功',
                type: 'success',
                duration: 2000
              })
              this.btnLoading = false
            }).catch(() => {
              this.btnLoading = false
            })
          }
        })
      },
      handleInnerUpdate5(row) {
        this.innerTemp5 = Object.assign({}, row) // copy obj
        this.payTypeDisabled = true
        this.dialogStatus = 'update'
        this.innerDialogFormVisible5 = true
        this.innerTemp5.orders_payment_id = this.temp.orders_payment.id
        this.innerTemp5.orders_pay_type_id = row.orders_pay_type.id
        this.innerTemp5.orders_payment_item_id = row.id
        this.$nextTick(() => {
          this.$refs['innerDataForm5'].clearValidate()
        })
      },
      updateInnerData5() {
        this.$refs['innerDataForm5'].validate((valid) => {
          if (valid) {
            const tempData = Object.assign({}, this.innerTemp5)
            updateOrdersPaymentItem(tempData).then(response => {
              this.innerTemp5.updated_at = response.data.updated_at
              for (const v of this.temp.orders_payment.orders_payment_items) {
                if (v.id === this.innerTemp5.id) {
                  const index = this.temp.orders_payment.orders_payment_items.indexOf(v)
                  this.temp.orders_payment.orders_payment_items.splice(index, 1, this.innerTemp5)
                  break
                }
              }
              this.handleCashOnDeliveryPaidMoney()
              this.innerDialogFormVisible5 = false
              this.$notify({
                title: '成功',
                message: '更新成功',
                type: 'success',
                duration: 2000
              })
            })
          }
        })
      },
      handleInnerDelete5(row) {
        this.$confirm('确定删除收款信息?', '提示', {
          confirmButtonText: '确定',
          cancelButtonText: '取消',
          type: 'warning'
        }).then(() => {
          row.status = 2
          const tempData = {orders_payment_item_id: row.id, orders_id: this.temp.id}
          deleteOrdersPaymentItem(tempData).then(response => {
            this.$notify({
              title: '成功',
              message: '删除成功',
              type: 'success',
              duration: 2000
            })
            const index = this.temp.orders_payment.orders_payment_items.indexOf(row)
            this.temp.orders_payment.orders_payment_items.splice(index, 1, row)
            this.handleCashOnDeliveryPaidMoney()
          })
        }).catch(() => {
          this.$message({
            type: 'info',
            message: '已取消删除'
          })
        })
      },
      handleOpenInner7(row) {
        if (row.status !== 10) {
          this.$confirm('申请退款将会影响业绩, 确定此订单发起申请退款?', '提示', {
            confirmButtonText: '确定',
            cancelButtonText: '取消',
            type: 'warning'
          }).then(() => {
            createDirectPromotionRefund({orders_id: row.id}).then(response => {
              row.status = 10
              this.openInnerDialog7(row)
            })
          }).catch(() => {
            this.$message({
              type: 'info',
              message: '已取消退款申请'
            })
          })
        } else {
          this.openInnerDialog7(row)
        }
      },
      openInnerDialog7(row) {
        getDirectPromotionRefundInfo({orders_id: row.id}).then(response => {
          this.innerTemp7.orders_id = row.id
          this.innerTemp7 = response.data
          this.innerDialogFormVisible7 = true
        })
      },
      updateInnerData7() {
        const tempData = Object.assign({}, this.innerTemp7)
        updateDirectPromotionRefund(tempData).then(response => {
          this.innerDialogFormVisible7 = false
          this.$notify({
            title: '成功',
            message: '更新成功',
            type: 'success',
            duration: 2000
          })
        })
      },
      handleOpenImage(imageUrl) {
        this.publicImageUrl = imageUrl
        this.imageDialogVisible = true
      },
      checkPre(row) {
        console.log(row)
        this.tableDialogVisible = true
        this.listQuery1.product_weixin_fans_id = row.product_weixin_fans_id
        this.getList2()
      },
      getList2() {
        this.listLoading = true
        getOrdersList(this.listQuery1).then(response => {
          this.list1 = response.data.data
          this.total1 = response.data.total
          this.listLoading = false
        })
      },
      downExcel() {
        // console.log(this.listQuery.date_range)
        const form = document.createElement('form')
        form.action = process.env.BASE_API + '/api/orders/downloadSaleData' + '?token=' + this.$store.state.user.token
        form.method = 'post'
        form.style.display = 'none'
        // 订单状态
        const orders_status = document.createElement('input')
        orders_status.name = 'status'
        orders_status.value = this.listQuery.status
        form.appendChild(orders_status)
        // 订单号
        const warehouse_id = document.createElement('input')
        warehouse_id.name = 'warehouse_id'
        warehouse_id.value = this.listQuery.warehouse_id
        form.appendChild(warehouse_id)
        // 订单号
        const orders_unique_id = document.createElement('input')
        orders_unique_id.name = 'orders_unique_id'
        orders_unique_id.value = this.listQuery.orders_unique_id
        form.appendChild(orders_unique_id)
        // 物流单号
        const orders_logistics_number = document.createElement('input')
        orders_logistics_number.name = 'orders_logistics_number'
        orders_logistics_number.value = this.listQuery.orders_logistics_number
        form.appendChild(orders_logistics_number)
        // 客服部门
        if (this.listQuery.support_user_account_group_id !== '') {
          const support_user_account_group_id = document.createElement('input')
          support_user_account_group_id.name = 'support_user_account_group_id'
          support_user_account_group_id.value = this.listQuery.support_user_account_group_id
          form.appendChild(support_user_account_group_id)
        }
        // 客服
        if (this.listQuery.support_user_account_id !== '' && this.listQuery.support_user_account_id !== undefined) {
          const support_user_account_id = document.createElement('input')
          support_user_account_id.name = 'support_user_account_id'
          support_user_account_id.value = this.listQuery.support_user_account_id
          form.appendChild(support_user_account_id)
        }
        // 搜索微信号
        const product_weixin_id = document.createElement('input')
        product_weixin_id.name = 'product_weixin_id'
        product_weixin_id.value = this.listQuery.product_weixin_id
        form.appendChild(product_weixin_id)
        // 产品
        const product_id = document.createElement('input') // 产品名称
        product_id.name = 'product_id'
        product_id.value = this.listQuery.product_id
        form.appendChild(product_id)
        // 备注
        const remark = document.createElement('input')
        remark.name = 'remark'
        remark.value = this.listQuery.remark
        form.appendChild(remark)
        let hasTime = false
        if (this.listQuery.date_range !== null && this.listQuery.date_range !== undefined && this.listQuery.date_range !== '') {
          hasTime = true
          const date_range = document.createElement('input')
          const date_range2 = document.createElement('input')
          date_range.name = 'date_range[0]'
          date_range.value = this.listQuery.date_range[0]
          date_range2.name = 'date_range[1]'
          date_range2.value = this.listQuery.date_range[1]
          form.appendChild(date_range)
          form.appendChild(date_range2)

          const sdate = new Date(date_range.value)
          const now = new Date(date_range2.value)
          const days = now.getTime() - sdate.getTime()
          const day = parseInt(days / (1000 * 60 * 60 * 24))
          if (day > 31) {
            this.$message({
              type: 'info',
              message: '最多只能导出30天数据'
            })
            return
          }
        }
        if (this.listQuery.created_at !== null && this.listQuery.created_at !== undefined && this.listQuery.created_at !== '') {
          hasTime = true
          const created_at = document.createElement('input')
          const created_at2 = document.createElement('input')
          created_at.name = 'created_at[0]'
          created_at.value = this.listQuery.created_at[0]
          created_at2.name = 'created_at[1]'
          created_at2.value = this.listQuery.created_at[1]
          form.appendChild(created_at)
          form.appendChild(created_at2)

          const sdate = new Date(created_at.value)
          const now = new Date(created_at2.value)
          const days = now.getTime() - sdate.getTime()
          const day = parseInt(days / (1000 * 60 * 60 * 24))
          if (day > 31) {
            this.$message({
              type: 'info',
              message: '最多只能导出30天数据'
            })
            return
          }
        }
        if (hasTime !== true) {
          this.$message({
            type: 'info',
            message: '必须选择时间'
          })
          return
        }
        // else {
        //   const date_range = document.createElement('input')
        //   const date_range2 = document.createElement('input')
        //   date_range.name = 'date_range[0]'
        //   date_range.value = parseTime(new Date(), '{y}-{m}-{d}')
        //   date_range2.name = 'date_range[1]'
        //   date_range2.value = parseTime(new Date(), '{y}-{m}-{d}')
        //   form.appendChild(date_range)
        //   form.appendChild(date_range2)
        //   // console.log(parseTime(new Date(), '{y}-{m}-{d}'))
        // }

        const button = document.createElement('input')
        button.type = 'submit'
        form.appendChild(button)
        document.body.appendChild(form)
        form.submit()
        document.body.removeChild(form)
      }
      // getRemark(remake) {
      //   var remarks;
      //   // var remake = scope.row.orders_remarks;
      //   for(var i = 0; i<remake.length;i++ ){
      //     remarks += remake[i].remark
      //   }
      //   console.log(remarks)
      //   return remarks;
      // },
    },
    deactivated() {
      this.scrollTop = document.documentElement.scrollTop || document.body.scrollTop
    },
    activated() {
      window.scrollTo(0, this.scrollTop)
      if (this.$route.query.refresh !== undefined && this.$route.query.refresh !== null) {
        this.handleFilter()
      }
    },

  }
</script>
<style scoped>
  .el-tag {
    /*height: 24px;*/
    /*line-height: 22px;*/
    /*font-size: 14px;*/
    /*padding: 0 4px;*/
  }

  .el-form--inline .el-form-item__content {
    width: 85%;
    padding: 5px 15% 0px 0px;
  }

  .demo-table-expand {
    font-size: 0;
  }

  .demo-table-expand label {
    width: 15%;
    color: #5e81bf;
    font-size: 16px;
  }

  .my-edit-type, .my-edit-type:focus {
    color: #288ccb;
    cursor: pointer;
  }

  .demo-table-expand .el-form-item {
    margin-right: 0;
    margin-bottom: 15px;
    width: 49%;
    margin-left: 1%;
  }

  .my-form-p {
    margin: 0;
    padding: 0;
    line-height: 20px;
    color: #333;
  }

  .label-span {
    font-weight: bold;
    color: #5e81bf;
  }

  .deleted-p {
    text-decoration: crimson underline overline line-through;
    text-decoration: underline overline line-through;
  }

  .grid-content {
    text-align: left;
    background-color: #edf2f9;
    color: #323233;
    padding: 15px 25px;
  }

  .filtered {
    -webkit-filter: url(#f1);
    filter: url(#f1);
  }

  .data-items {
    padding-left: 50px;
  }
</style>
